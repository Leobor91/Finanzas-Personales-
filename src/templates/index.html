<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Finanzas Personales — Registrar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>
    <div class="container">
      <div class="card centered p-4">
        <div class="d-flex align-items-center mb-3">
          <div class="me-auto">
            <div class="logo h4 mb-0">Finanzas Personales</div>
            <div class="small-muted">Registrar Ingresos y Gastos</div>
          </div>
          <div>
            <a href="/ui/reports" class="btn btn-outline-primary btn-sm me-2">Ver Reportes</a>
            <a href="/categories/all" class="btn btn-outline-secondary btn-sm">Ver Categorías</a>
          </div>
        </div>

        <form id="register-form" class="row g-3 needs-validation" novalidate>
          <div class="col-md-4">
            <label class="form-label">Fecha</label>
            <input name="date" type="date" class="form-control" required>
            <div class="invalid-feedback">Seleccione una fecha válida.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Tipo</label>
            <select name="type" class="form-select" required>
              <option value="Ingreso">Ingreso</option>
              <option value="Gasto">Gasto</option>
            </select>
            <div class="invalid-feedback">Seleccione un tipo.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Monto</label>
            <input name="amount" type="number" step="0.01" class="form-control" required>
            <div class="invalid-feedback">El monto debe ser mayor a 0.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Categoría</label>
            <div class="input-group">
              <select name="category" id="category-select" class="form-select" required>
                <option value="">Cargando...</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" id="add-cat-btn">+</button>
            </div>
            <div class="invalid-feedback">Indica una categoría.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Descripción (opcional)</label>
            <input name="description" class="form-control">
          </div>

          <div class="col-12">
            <button class="btn btn-primary" id="submit-btn">Registrar movimiento</button>
            <div id="alert-placeholder" class="mt-3"></div>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Category modal HTML
    const catModalHtml = `
      <div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Nueva categoría</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <div class="mb-3"><label class="form-label">Nombre</label><input id="new-cat-name" class="form-control"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button id="save-cat" class="btn btn-primary">Guardar</button></div>
          </div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', catModalHtml);
    const catModal = new bootstrap.Modal(document.getElementById('catModal'));
    (function () {
      // Bootstrap validation
      const form = document.getElementById('register-form');
      const alertPlaceholder = document.getElementById('alert-placeholder');

      function showAlert(message, type = 'success') {
        alertPlaceholder.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      }

      // load categories based on type
      async function loadCategoriesForType(type){
        const sel = document.getElementById('category-select');
        sel.innerHTML = '<option value="">Cargando...</option>';
        try{
          const res = await fetch(`/categories?type=${encodeURIComponent(type)}`);
          const json = await res.json();
          sel.innerHTML = '';
          if(res.status===200 && Array.isArray(json)){
            for(const c of json){
              const opt = document.createElement('option'); opt.value=c.name; opt.innerText=c.name; sel.appendChild(opt);
            }
          } else {
            sel.innerHTML = '<option value="">(sin categorías)</option>';
          }
        }catch(e){ sel.innerHTML = '<option value="">(error)</option>'; }
      }

      const typeSel = form.querySelector('select[name="type"]');
      typeSel.addEventListener('change', ()=> loadCategoriesForType(typeSel.value));
      // initial load
      loadCategoriesForType(typeSel.value);

      // add category flow
      document.getElementById('add-cat-btn').addEventListener('click', ()=>{ document.getElementById('new-cat-name').value=''; catModal.show(); });
      document.getElementById('save-cat').addEventListener('click', async ()=>{
        const name = document.getElementById('new-cat-name').value.trim();
        const type = typeSel.value;
        if(!name) return alert('Nombre requerido');
        try{
          const res = await fetch('/categories', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({type, name})});
          if(res.status===201){
            catModal.hide();
            await loadCategoriesForType(type);
            // select the new category
            const sel = document.getElementById('category-select'); sel.value = name;
          } else { const j = await res.json(); alert('Error: '+(j.error||JSON.stringify(j))); }
        }catch(e){ alert('Error de red: '+e.message); }
      });

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        e.stopPropagation();
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        const data = Object.fromEntries(new FormData(form).entries());
        // Basic client-side checks
        if (Number(data.amount) <= 0) {
          showAlert('El monto debe ser mayor a cero.', 'danger');
          return;
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = 'Registrando...';
        try {
          const res = await fetch('/movements', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
          });
          const json = await res.json();
          if (res.status === 201) {
            showAlert('Movimiento registrado (id: ' + json.id + ')', 'success');
            form.reset();
            form.classList.remove('was-validated');
          } else {
            showAlert('Error: ' + (json.error || JSON.stringify(json)), 'danger');
          }
        } catch (err) {
          showAlert('Error de red o del servidor: ' + err.message, 'danger');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerText = 'Registrar movimiento';
        }
      }, false);
    })();
    </script>
  </body>
</html>
